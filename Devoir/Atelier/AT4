numero1:

CREATE TABLE produits (
	id SERIAL PRIMARY KEY,
	nom VARCHAR(255),
	quantite INT,
	prix FLOAT(10)
)

CREATE TABLE transactions(
	id SERIAL PRIMARY KEY,
	quantite INT,
	FOREIGN KEY (id) REFERENCES produits (id),
	moment TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)

CREATE TABLE ventes(
)INHERITS (transactions);

CREATE TABLE achats(
)INHERITS (transactions);

CREATE TABLE ajustements(
)INHERITS (transactions);

INSERT INTO produits (nom, quantite, prix) VALUES ('PS4',12, 321);
INSERT INTO produits (nom, quantite, prix) VALUES ('DELL XP 15',24, 1269);
INSERT INTO produits (nom, quantite, prix) VALUES ('Z-FLIP 5',36, 1529);

numero2:
CREATE OR REPLACE PROCEDURE ajuster_quantite(IN produits_id INT, IN quantite_ajuster INT)
	language plpgsql
AS $$
BEGIN
	IF NOT EXISTS (SELECT 1 FROM produits WHERE id = produits_id) THEN 
		RAISE EXCEPTION 'The product with id % does not exist.', produit_id;
	END IF;
	
	INSERT INTO transactions
							(quantite)
	VALUES					(@quantite_ajuster);
	
	UPDATE produits	
	SET    quantite = quantite_ajuster 
	WHERE	id = produits_id;
END; 
$$;


CALL ajuster_quantite(1, 24);

numero 3:

CREATE OR REPLACE PROCEDURE ajouter_transaction(IN produits_id INT, IN quantite_acheter INT)
	language plpgsql
AS $$
BEGIN
	IF EXISTS (SELECT 1 FROM produits WHERE id = produits_id) THEN
		RAISE EXCEPTION 'The product with id % already exist.', produit_id;
	ELSIF (quantite_acheter > 0)THEN
		IF (quantite_acheter > (SELECT quantite FROM produits WHERE id = produits_id) ) THEN
			RAISE EXCEPTION 'Il ne reste pas assez de %', (SELECT nom FROM produits WHERE id = produits_id);
		END IF;
	ELSE 	quantite_acheter= -quantite_acheter;
	END IF;
	
	INSERT INTO ventes 
						(quantite)
	VALUES				(quantite_acheter);
	
	UPDATE produits	
	SET    quantite = quantite - quantite_acheter
	WHERE	id = produits_id;
END; 
$$;
